<!DOCTYPE html>
<html>
<head>
	<title>PASTE - LIST</title>
	{% load static %}
	{% include 'head.html' %}
	<link href="{% static 'bin/paste/index.css' %}" rel="stylesheet">
</head>
<body>

{% load to_str %}
{% load range %}

{% include 'header.html' %}


<main>

<a href="create">
	<button id="goto-create-paste">
		
	</button>
</a>

<div class="title-container" style="background-color: #fefefe;">
	<div class="title-flex">
		<div class="title-child">
			PASTE - {{ pastes|length }}
		</div>

		<div class="result-found-number-child" id="paste-result-number">
			
		</div>

		{% csrf_token %} <!-- tags django √† mettre pour tous les formulaires pour √©viter les erreur CSRF lors du post,
		ici ce n'est pas vraiment un <form> mais on au clic du bouton 'search-button', on fait un requ√™te ajax avec jquerry.
		On a d'ailleurs besoin lors de cette requ√™te avec jquerry d'une fonction de v√©rification CSRF, ainsi donc d'une fonction 
		getCookie, la fonction getCookie vient de la documentation de django √† propos des requ√™te ajax : <LIEN_A_METTRE> -->
		<div class="input-child">
			<button id="show-all-button" onclick="showAllPaste()">Tout afficher ?</button>
			<input id="search-input" placeholder="Search paste"><button id="search-button">
				<i class="fas fa-search"></i>
			</button>
		</div>
	</div>
</div>

<div class="separator-2" style="background-color: #fefefe;display: block;border-bottom: 2vh solid #fefefe;">
  <div class="separator2-header" style="width: 70%;border: 1px solid #204ecf;margin: auto;"></div>
</div>


<button id="search-logo">

</button>

<div class="parent">
	{% for post in pastes %}
	<a href="{% url 'bin:show' post.id %}" class="child" id="paste-{{ post.id }}">
		<div class="details">
			<span class="created_at">
				üïê {{ post.there_is_ago }}
			</span>
			<span class="views_number">
				{{ post.views }} üëÅ
			</span>
			<span class="title">
				{{ post.title|upper|truncatechars:50 }}
			</span>
		</div>

		<div class='overlay'>
			<!--<a href="/bin/paste/{{ post.id }}">
				<button class="action">
					LIRE LA SUITE
				</button>
			</a>-->

			<!--<span class="id">
				{{post.id}} {{ post.views }} vues
			</span>-->

			<img src="{{ post.img }}" onerror="this.src=`{% static 'bin/paste/error_image.png' %}`">

			<!--<div class="icon">
				<i class="fas fa-file-code"></i>
			</div>-->
			<!--<div class="triangle">Hello world</div>-->

		</div>
	</a>

	<div id="result-not-found">
		<p>No result found for <q id="result-not-found-search"></q></p>
		<!--don't let space between <p> and texte cause of white-space:pre-wrap-->
	</div>

	<!--{% if not forloop.last %}
	
	{% endif %}-->

	{% empty %}
	
	<h1>NO PASTE</h1>

	{% endfor %}
</div>


</main>

{% include 'footer.html' %}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>



<script>
	$(document).ajaxStart(function() {
		console.log("start")
		$("#search-logo").show()
	}).ajaxStop(function () {
		$("#search-logo").hide();
    });

    function ajaxSearchRequest() {
		let input = document.getElementById("search-input");
		let resultLabel = document.getElementById("paste-result-number")
		if (input.value == "") {
			resultLabel.innerHTML = "<span style='color:red'>Aucune saisie !</span>";
			return;
		}
		$("#result-not-found").hide()
		$.ajax({
				type:"POST",
				url:"./search", // url enregistr√© dans `applications.bin.urls`, view enregistr√© dans `applications.bin.urls`
								// trait√© uniquement si la requ√™te est dites ajax. Sinon raise 404
				data:"input=" + input.value,
				success:function(data) {
					let find_number = 0;
					for(x of data) {
						if (x[1] == true) {
							find_number++;
							document.getElementById("paste-"+x[0]).style.display = "block";
						} else {
							document.getElementById("paste-"+x[0]).style.display = "none";
						}
					}

					if (find_number <= 0) { // <= pour emp√™cher de bypass, mais normalement c'est un simple ==
						resultLabel.innerHTML = "0 r√©sultat";
						$("#result-not-found").show()
						document.getElementById("result-not-found-search").innerHTML = " " + input.value + " ";
					} else if (find_number == 1) {
						resultLabel.innerHTML = "1 r√©sultat";
					} else {
						resultLabel.innerHTML = find_number + " r√©sultats";
					}
				}
			});
	}

	$(document).ready(function() {

		$('#search-button').click(ajaxSearchRequest);
		$('#search-input').keypress(function(event) {
		    if(event.keyCode == '13' || event.which == '13') ajaxSearchRequest();
		});

		

		function getCookie(name) {
		    let cookieValue = null;
		    if (document.cookie && document.cookie !== '') {
		        const cookies = document.cookie.split(';');
		        for (let i = 0; i < cookies.length; i++) {
		            const cookie = cookies[i].trim();
		            // Does this cookie string begin with the name we want?
		            if (cookie.substring(0, name.length + 1) === (name + '=')) {
		                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
		                break;
		            }
		        }
		    }
		    return cookieValue;
		}
		var csrftoken = getCookie('csrftoken');

		function csrfSafeMethod(method) {
			return (/^GET|HEAD|OPTIONS|TRACE$/.test(method));
		}

		// √† chaque requ√™te ajax, la v√©rification csrf est appel√©
		$.ajaxSetup({
			crossDomain: false,
			beforeSend:function(xhr, settings) {
				if (!csrfSafeMethod(settings.type)) {
					xhr.setRequestHeader("X-CSRFToken", csrftoken);
				}
			}
		})

});
</script>

<script type="text/javascript">
	function showAllPaste() {
		document.getElementById("result-not-found").style.display = "none";
		let children = document.getElementsByClassName("child");
		for (child of children) {
			child.style.display = "block";
		}

		const resultLabel = document.getElementById("paste-result-number")
		resultLabel.innerHTML = "Tout est maintenant affich√© !";

		setTimeout(function () {
			resultLabel.innerHTML = ""
		}, 3000)
	}

</script>

</body>
</html>